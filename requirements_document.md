# iPhone需要予測システム - 要件定義書

## 1. 背景・目的（Why）

### 目的
iPhoneの販売台数を精度高く予測し、以下の意思決定を最適化する：
- 月次S&OPの需要計画（国/チャネル/モデル別）
- 量産・発注（部材LTと合わせたM+3～M+6視点）
- 新機種発売前の生産立ち上げ計画、旧機種のEOL在庫引き当て

### 成功基準
- 主要国×月のMAPE ≤ 12%（発売月を除く）
- 新機種ローンチ±2か月のWAPE ≤ 18%
- 需要欠品率（予測起因）を四半期で▲30%

## 2. 予測対象（What）

### ターゲット変数
販売台数（Sell-out基準、必要に応じてSell-inも並行）

### 粒度
- **地域**: 国（またはリージョン）
- **チャネル**: 直販/キャリア/量販/EC
- **機種**: Pro/Pro Max/無印/Plus（容量/色は集約）
- **時間**: 週次/月次

### 予測地平
- 週次: 8～12週先
- 月次: 6～12か月先

### ヒエラルキー
全社 → リージョン → 国 → チャネル → 機種（Top-down/Bottom-up両用の階層型予測）

## 3. スコープと前提・除外

### 含む
- 新機種発売サイクル
- 価格改定
- プロモーション
- 在庫制約の影響
- 競合発売
- マクロ経済要因

### 除外（初期フェーズ）
- グレー市場横流し
- 非正規リセール
- B2B一括案件のスポット（注記で別管理）

### 前提
- データ可用性（最低24–36か月の履歴）
- 主要販売国の基礎データ接続

## 4. ステークホルダー（Who）

### オーナー
Ops（需要計画/サプライプランニング）

### 主要関係者
- Sales（チャネル担当）
- Marketing（価格・販促）
- Finance（計画/着地）
- Supply Chain（調達/生産）

### 意思決定リズム
- 週次Ops会議
- 月次S&OP

## 5. データ要件（Inputs）

### 必須（内部）
- 販売実績（Sell-out/Sell-in、国×チャネル×機種×週/月）
- 在庫（倉庫・店舗・チャネル在庫、手持ち日数）
- 価格と販促（定価、実売価格、割引率、下取り、キャリア補助）
- 流通制約（入荷・欠品・在庫切れフラグ）
- 新機種情報（発売日、モデル仕様、SKU階層、旧機種EOL）

### 推奨（外部）
- マクロ（可処分所得、CPI、為替、失業率、金利）
- 季節性（祝日、セール、給料日、ブラックフライデー、旧正月などのカレンダー）
- 競合指標（主要他社発売日/価格、検索トレンド代替）
- 需要シグナル（Webトラフィック、PV、予約/取り寄せ件数、SNSバズ指数）

### 品質要件
- 欠損・異常値ルール（例：在庫ゼロ週の販売ゼロは需要抑圧として補正）
- 一意キー：`country|channel|model|yyyymm(ww)`
- リード/ラグ整備（価格/プロモは0～2週先行効果を特徴量化）

## 6. 特徴量設計（Features）

### 時系列
- トレンド
- 週/月ダミー
- 移動平均
- 前年同週
- 発売後経過週（lifecycle curve）

### 価格・プロモ
- 実売価格
- 割引率
- 弾力性（機種別に推定）
- 販促強度指数

### 供給制約
- 在庫日数
- 欠品フラグ
- 入荷リードタイム

### 競合
- 競合発売±n週ダミー
- 相対価格差
- カテゴリー検索指数

### マクロ
- 為替
- 所得代理
- 物価指数

### カレンダー
- セールイベント
- 祝日
- 給与日
- 学期・ボーナス期

### 相関
- 予約台数
- Web先行指標（lagged）

## 7. モデル方針（How）

### ベースライン
階層型時系列（Prophet/SARIMA/ETS）＋カレンダー・発売ダミー

### 拡張
機械学習の回帰（XGBoost/LightGBM）で価格・プロモ・在庫など説明変数を統合

### 新機種Cold Start
類似機種のライフサイクル曲線（S字/ピーク時期）＋相対価格×予約情報のベイズ更新

### 階層整合
Bottom-upとTop-downの最適化（MinT/OLSで整合）

### シナリオ
価格±x%、プロモ強度、供給制約（入荷遅延）を操作するシミュレーター

## 8. 評価指標・検証

### 指標
- MAPE（Mean Absolute Percentage Error）
- WAPE（Weighted Absolute Percentage Error）
- SMAPE（Symmetric MAPE）
- Bias（平均誤差）
- 在庫欠品起因の失販売（Lost Sales推定）

### ウィンドウ
- ロールフォワード時系列CV（Origin-rolling）
- 発売前後の特別枠

### ベンチマーク
単純Naive（前年同月/移動平均）に対する改善率≥20%

### 例外週処理
発売週・大型セール週は個別評価トラックを分離

## 9. 運用要件（MLOps/Process）

### 更新頻度
- 週次推定（12週先）
- 月次確報（12か月先）

### 入力フロー
ETL → 検品（異常検知）→ 特徴量生成 → 学習/更新 → 予測配信

### 配信形式
- Dashboard（国/チャネル/機種ピボット、誤差ヒートマップ）
- CSV出力
- API

### 権限
- 閲覧（Sales/Marketing）
- 編集（Ops/DS）
- 監査ログ

### 監視
- データドリフト
- 誤差ドリフト
- 発売週の警報閾値

### 再学習
- 月次フル
- 週次インクリメンタル

## 10. シナリオ/意思決定連携

### 在庫・生産
サービスレベル目標に基づく安全在庫最適化（予測分布×LT）

### 価格/販促
弾力性×在庫からの粗利最大化（簡易最適化）

### S&OP
上振れ/下振れレンジ（P10–P90）提示、コンセンサス形成ログ

## 11. リスク・制約

- データ遅延・欠損
- 販促メタデータの不統一
- 並行発売のカニバリ
- 非観測要因（キャリア施策の急変）
- 供給ショック（工場・物流）
- 為替急変

## 12. ガバナンス・コンプライアンス

- 個人情報なし（集計単位のみ）
- 外部データのライセンス順守
- モデルの説明責任（主要特徴の寄与を可視化）

## 13. 成果物（Deliverables）

1. 要件定義書（本ドキュメント）
2. データ辞書（カラム、型、主キー、更新頻度）
3. 検証レポート（指標・ベンチマーク・誤差分布・発売週検証）
4. ダッシュボード（粒度別の予測・誤差・在庫連携）
5. シナリオシミュレータ（価格/プロモ/供給制約の感応度）

## 14. タイムライン（8週間）

- **W1–2**: データ収集・データ辞書・欠損/異常ルール確定
- **W3–4**: ベースライン時系列＋カレンダー・発売効果、評価設計
- **W5–6**: ML拡張（価格・プロモ・在庫・競合）、階層整合、Cold Start
- **W7**: ダッシュボード＆シナリオ、関係部門レビュー
- **W8**: 本番運用トライアル（週次運用）、改善計画

## 付録A：データ辞書

| フィールド | 説明 | 例 | 必須 |
|-----------|------|-----|------|
| date_key | 週末日/年月 | 2025-10-26 / 2025-10 | 必須 |
| country | ISO/国名 | JP | 必須 |
| channel | 直販/キャリア/量販/EC | Carrier | 必須 |
| model | 例：15 Pro | iPhone 15 Pro | 必須 |
| sales_units | 売上台数（sell-out） | 12,345 | 必須 |
| sell_in_units | 出荷台数 | 10,800 | 任意 |
| on_hand_days | 手持ち在庫日数 | 21 | 任意 |
| price_realized | 実売平均価格 | 148000 | 任意 |
| discount_rate | 割引率 | 0.1 | 任意 |
| promo_flag | プロモ実施 | 0/1 | 任意 |
| launch_week | 発売後経過週 | 5 | 任意 |
| stockout_flag | 欠品 | 0/1 | 任意 |
| competitor_launch | 競合発売±2週 | 0/1 | 任意 |
| holiday_flag | セール/祝日 | BF/NY | 任意 |
| web_interest | 検索/トラフィック指数 | 78 | 任意 |
| return_rate | 返品率 | 0.02 | 任意 |

## 付録B：評価テンプレート

### 期間
直近24か月、主要5か国

### 指標出力
MAPE/WAPE/BIAS（総計・粒度別）、発売週別SMAPE

### 可視化
- 国×機種ヒートマップ
- 誤差分布
- 実績vs予測の時系列

## 付録C：シナリオ設計（例）

### 価格-5%
需要＋ε（機種別弾力性で変化）、粗利影響

### プロモ強度+1段階
販売増分と在庫引当

### 供給制約（入荷-20%）
欠品率・失販売・繰越需要
