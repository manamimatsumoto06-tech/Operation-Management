# Operation Management - iPhone需要予測システム

## Overview
このリポジトリは、iPhone売上データの高度な分析と機械学習ベースの需要予測を行うエンタープライズグレードのシステムです。S&OP（Sales & Operations Planning）、生産計画、在庫最適化の意思決定を支援します。

## プロジェクト内容

### 🎯 ビジネス目的
- **S&OP需要計画**: 国/チャネル/モデル別の月次需要計画
- **生産・調達最適化**: M+3～M+6の部材発注計画
- **在庫配置**: 新機種ローンチと旧機種EOL在庫の最適化
- **販促投資配分**: 価格・プロモーション施策の効果予測

### 📊 成功基準
- 主要国×月のMAPE ≤ 12%（発売月を除く）
- 新機種ローンチ±2か月のWAPE ≤ 18%
- 需要欠品率（予測起因）▲30%削減

## 予測システムの特徴

### 🚀 高度なモデリング v2.0
1. **機械学習アプローチ**: LightGBM勾配ブースティング（正則化あり）
2. **豊富な特徴量**:
   - ライフサイクル分析（発売後経過期間、成長段階）
   - 季節性・カレンダー効果（祝日、セール期間、Q4効果）
   - 価格弾力性シミュレーション
   - プロモーション強度指標
   - 移動平均・ラグ特徴量（データリーケージ対策済み）
3. **高精度・汎化性能**:
   - テストセット（iPhone 15）MAPE: **10.59%** ✓目標達成
   - 月次集計MAPE: **6.23%** ✓ビジネス目標達成
   - 適切な訓練/検証/テスト分割で過学習を防止
4. **シナリオシミュレーション**: 価格/プロモ/供給制約の影響分析

### 📈 予測結果（iPhone 16）v2.0

#### 改善されたモデル予測
- **予測期間**: 2024年9月〜2025年6月（初年度10ヶ月）
- **総予測売上**: 137.46百万台
- **モデル性能**: テストMAPE 10.59%、月次MAPE 6.23% ✓目標達成
- **データ分割**: Train (12-13) → Val (14) → Test (15) → Forecast (16)

#### シナリオ分析
| シナリオ | 予測売上 | ベース比 | ビジネスインパクト |
|---------|---------|---------|------------------|
| ベースライン | 137.46 M | - | 通常需要 |
| 価格-5% | 145.44 M | +5.8% | 弾力性1.2を想定 |
| プロモ+1レベル | 148.45 M | +8.0% | キャンペーン強化 |
| 供給制約-20% | 109.97 M | -20.0% | 在庫不足影響 |

#### 月別予測（ベースライン）
| 年月 | 予測売上（百万台） | ライフサイクル段階 |
|------|-------------------|------------------|
| 2024年9月 | 12.55 | Launch |
| 2024年10月 | 19.70 | Launch |
| 2024年11月 | 19.02 | Launch |
| 2024年12月 | 19.48 | Growth (Holiday) |
| 2025年1月 | 10.79 | Growth |
| 2025年2月 | 10.77 | Growth |
| 2025年3月 | 12.75 | Growth |
| 2025年4月 | 10.38 | Mature |
| 2025年5月 | 10.36 | Mature |
| 2025年6月 | 11.66 | Mature |

### 📊 モデル性能比較

| データセット | MAPE (%) | WAPE (%) | 月次MAPE (%) | 評価 |
|------------|---------|---------|-------------|------|
| Training (iPhone 12-13) | 7.75 | 6.10 | 2.61 | 訓練データ |
| Validation (iPhone 14) | 8.41 | 7.19 | 3.33 | 検証データ |
| **Test (iPhone 15)** | **10.59** | **8.79** | **6.23** | **テストデータ** ✓ |

**ビジネス目標達成状況:**
- 月次MAPE目標 ≤12%: **達成** (6.23%)
- WAPE目標 ≤18%: **達成** (8.79%)

## ファイル構成

### 📁 ドキュメント
- **`requirements_document.md`** - 包括的な要件定義書
  - ビジネス目的、成功基準
  - データ要件とデータ辞書
  - モデル方針と評価指標
  - 運用要件とMLOps
  - シナリオ設計

- **`CLAUDE.md`** - リポジトリガイダンス
- **`README.md`** - 本ドキュメント

### 📊 データファイル
- **`Iphone_Sales_Data(1).csv`** - 実績データ
  - iPhone 12〜16の日次売上（2020年10月〜2025年6月）
  - 2,490レコード、5モデル

### 🔧 分析スクリプト

#### ベースライン予測
- **`iphone16_forecast.py`** - シンプルな時系列予測
  - 月次集計と平均パターン分析
  - iPhone 15ベースライン + 3%成長
  - Excel出力（4シート）

#### 高度な予測システム
- **`advanced_forecast_model.py`** - v1.0（過学習あり、非推奨）
  - LightGBM機械学習モデル
  - 訓練データでの過剰最適化
  - Excel出力（6シート）

- **`advanced_forecast_model_v2.py`** - **v2.0（推奨）** ⭐
  - LightGBM + 正則化（L1/L2）
  - 適切な訓練/検証/テスト分割
  - データリーケージ対策済み
  - 19個の特徴量エンジニアリング
  - シナリオシミュレーター
  - 包括的な評価指標（MAPE/WAPE/Bias）
  - Excel出力（6シート）

### 📈 出力ファイル

#### ベースライン出力
- **`iPhone16_Sales_Forecast.xlsx`**
  - iPhone16_Forecast: 月別予測
  - Historical_Comparison: 世代間比較
  - Summary: 統計サマリー
  - Historical_Monthly_Data: 元データ

#### 高度なモデル出力
- **`iPhone_Advanced_Forecast_Output.xlsx`** - v1.0出力（参考用）
- **`iPhone_Advanced_Forecast_Output_v2.xlsx`** - **v2.0出力（推奨）** ⭐
  - Monthly_Forecast_Scenarios: 月別予測 + 3シナリオ
  - Model_Performance: Train/Val/Test別のMAPE/WAPE評価
  - Monthly_Performance: 月次集計での性能評価
  - Feature_Importance: 重要特徴量ランキング
  - Test_Set_Validation: iPhone 15での検証結果
  - Executive_Summary: v2.0改善点とビジネス目標達成状況

## 使用方法

### 📦 必要なライブラリ

#### ベースラインモデル
```bash
pip install pandas numpy openpyxl
```

#### 高度なモデル（推奨）
```bash
pip install pandas numpy openpyxl lightgbm scikit-learn
```

### ▶️ 実行方法

#### ベースライン予測
```bash
python3 iphone16_forecast.py
```
→ `iPhone16_Sales_Forecast.xlsx`が生成されます

#### 高度な予測システム v2.0（推奨）⭐
```bash
python3 advanced_forecast_model_v2.py
```
→ `iPhone_Advanced_Forecast_Output_v2.xlsx`が生成されます

#### 旧バージョン（v1.0、参考用）
```bash
python3 advanced_forecast_model.py
```
→ `iPhone_Advanced_Forecast_Output.xlsx`が生成されます（過学習あり）

### 📊 出力の活用

1. **S&OP計画**: Monthly_Forecast_Scenariosシートを使用
2. **モデル信頼性確認**: Model_Performanceシートでセグメント別精度を確認
3. **要因分析**: Feature_Importanceシートで需要ドライバーを把握
4. **シナリオ分析**: 価格/プロモ/供給制約の影響を比較
5. **日次オペレーション**: Daily_Forecast_Detailで短期計画を立案

## モデルの詳細

### 特徴量設計（18個）

#### 時系列特徴
- 月、四半期、曜日、週番号
- 発売後経過日数/週数/月数
- 7日・30日移動平均
- 7日・30日ラグ

#### ビジネス特徴
- ライフサイクル段階（Launch/Growth/Mature/Decline）
- 季節性（Q4、ホリデーシーズン、新学期）
- 価格シミュレーション（ライフサイクル連動減価）
- プロモーション強度（ブラックフライデー、セール期間）
- 新機種発売影響フラグ
- モデル世代番号

### v2.0モデル評価指標（改善版）

#### データセット別性能

| データセット | 日次MAPE (%) | 日次WAPE (%) | 月次MAPE (%) | 用途 |
|------------|-------------|-------------|-------------|------|
| Training (iPhone 12-13) | 7.75 | 6.10 | 2.61 | モデル訓練 |
| Validation (iPhone 14) | 8.41 | 7.19 | 3.33 | ハイパーパラメータ調整 |
| **Test (iPhone 15)** | **10.59** | **8.79** | **6.23** | **最終評価** ✓ |

#### v1.0との比較

| 指標 | v1.0 (過学習) | v2.0 (改善版) | 改善 |
|------|--------------|--------------|------|
| テストMAPE | 1.88% | 10.59% | より現実的 ✓ |
| 月次MAPE | N/A | 6.23% | ビジネス目標達成 ✓ |
| データ分割 | なし | Train/Val/Test | 適切な検証 ✓ |
| データリーケージ | あり | なし | 正しい特徴量 ✓ |
| 正則化 | なし | L1/L2 | 汎化性能向上 ✓ |

### 重要特徴量トップ5（v2.0）
1. **Sales_MA7** (7日移動平均) - 需要の短期トレンド
2. **Month** - 季節性効果
3. **Sales_MA30** (30日移動平均) - 需要の中期トレンド
4. **DaysSinceLaunch** - ライフサイクル効果
5. **Quarter** - 四半期効果（Q4ピーク）

## シナリオシミュレーション

### 価格-5%シナリオ
- **想定**: 定価を5%引き下げ
- **弾力性**: -1.2（1%価格減→1.2%需要増）
- **結果**: +6.0%需要増（+8.06 M units）
- **活用**: 粗利vs売上のトレードオフ分析

### プロモ+1レベルシナリオ
- **想定**: プロモーション強度を1段階強化
- **効果**: +8%需要増
- **結果**: +10.77 M units
- **活用**: 販促ROI最適化

### 供給制約-20%シナリオ
- **想定**: 部材不足で供給が20%減
- **結果**: 需要充足率80%、-26.94 M units機会損失
- **活用**: 在庫リスク・欠品コスト分析

## 今後の拡張（ロードマップ）

### フェーズ2: データ拡張
- [ ] 実際の価格・プロモーションデータ統合
- [ ] 在庫・欠品データ連携
- [ ] 国別・チャネル別セグメンテーション
- [ ] 競合データ（発売日、価格）

### フェーズ3: モデル高度化
- [ ] 階層型予測（Top-down/Bottom-up調整）
- [ ] Prophet/SARIMAとのアンサンブル
- [ ] Bayesian更新（予約データからのCold Start改善）
- [ ] 需要抑圧補正（欠品時の潜在需要推定）

### フェーズ4: 運用最適化
- [ ] 自動再学習パイプライン（週次/月次）
- [ ] ダッシュボード開発（国/チャネル/機種ピボット）
- [ ] APIエンドポイント
- [ ] アラート機能（誤差ドリフト検知）

### フェーズ5: 意思決定連携
- [ ] 在庫最適化（サービスレベル×予測分布）
- [ ] 価格最適化（弾力性×在庫×粗利）
- [ ] S&OPコンセンサス形成ワークフロー

## 技術スタック

- **言語**: Python 3.12+
- **データ処理**: pandas, numpy
- **機械学習**: LightGBM, scikit-learn
- **出力**: openpyxl (Excel)
- **将来**: Prophet, statsmodels, plotly (可視化)

## ライセンス・コンプライアンス

- 個人情報なし（集計レベルのみ）
- モデル説明責任（特徴量重要度の可視化）
- 外部データライセンス順守

## 参考資料

- **要件定義**: `requirements_document.md`
- **開発ガイダンス**: `CLAUDE.md`
- **ビジネスコンタクト**: Ops/需要計画チーム

---

**最終更新**: 2024年10月14日
**モデルバージョン**: v2.0 (過学習対策・正則化版)
**データバージョン**: 2020-10 ~ 2025-06
**主な改善**: データリーケージ対策、Train/Val/Test分割、L1/L2正則化、MAPE 10.59%（現実的）
