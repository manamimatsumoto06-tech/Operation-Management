# Operation Management - iPhone需要予測システム

## Overview
このリポジトリは、iPhone売上データの高度な分析と機械学習ベースの需要予測を行うエンタープライズグレードのシステムです。S&OP（Sales & Operations Planning）、生産計画、在庫最適化の意思決定を支援します。

## プロジェクト内容

### 🎯 ビジネス目的
- **S&OP需要計画**: 国/チャネル/モデル別の月次需要計画
- **生産・調達最適化**: M+3～M+6の部材発注計画
- **在庫配置**: 新機種ローンチと旧機種EOL在庫の最適化
- **販促投資配分**: 価格・プロモーション施策の効果予測

### 📊 成功基準
- 主要国×月のMAPE ≤ 12%（発売月を除く）
- 新機種ローンチ±2か月のWAPE ≤ 18%
- 需要欠品率（予測起因）▲30%削減

## 予測システムの特徴

### 🚀 高度なモデリング v3.0 Refined
1. **機械学習アプローチ**: LightGBM勾配ブースティング（Optuna最適化）
2. **豊富な特徴量**（24個）:
   - ライフサイクル分析（発売後経過期間、成長段階）
   - 季節性・カレンダー効果（祝日、セール期間、Q4効果）
   - 対数変換ラグ特徴量（ローンチフェーズの安定化）
   - 成長率メトリクス（加速度、前月比成長率）
   - インタラクション項（launch_x_stage等）
   - 移動平均・ラグ特徴量
3. **高精度・汎化性能**:
   - **iPhone 16（最初4ヶ月）MAPE: 13.34%** ✓目標達成（≤15%）
   - **WAPE: 13.56%** ✓目標達成
   - 外れ値検出・平滑化（±2σ閾値、4件補正）
   - ハイパーパラメータ最適化（Optuna 20試行）
4. **主要な改善**:
   - v1.0（MAPE 23.41%）→ v2.0（22.53%）→ **v3.0（13.34%）**
   - 約10ポイントの精度向上

### 📈 予測結果（iPhone 16）v3.0

#### 最適化モデル予測
- **予測期間**: 2024年9月〜2024年12月（最初4ヶ月）
- **モデル性能**: MAPE 13.34%、WAPE 13.56% ✓目標達成
- **クロスバリデーション**: 3-fold時系列CV、Best MAE: 0.784

### 📊 モデル性能比較（バージョン別）

| バージョン | iPhone 16 MAPE (%) | iPhone 16 WAPE (%) | 主な改善点 |
|-----------|-------------------|-------------------|-----------|
| v1.0 Baseline | 23.41 | 23.76 | 基本的な特徴量エンジニアリング |
| v2.0 Improved | 22.53 | 22.94 | 18個の強化された特徴量 |
| **v3.0 Refined** | **13.34** ✓ | **13.56** ✓ | **外れ値処理 + Optuna + 対数ラグ** |

**ビジネス目標達成状況:**
- MAPE目標 ≤15%: **達成** (13.34%)
- WAPE目標 ≤18%: **達成** (13.56%)

**特徴量重要度トップ3:**
1. ema3 (指数移動平均): 15,435
2. ma3 (3ヶ月移動平均): 8,363
3. launch_month: 4,399

## ファイル構成

### 📁 ドキュメント
- **`requirements_document.md`** - 包括的な要件定義書
  - ビジネス目的、成功基準
  - データ要件とデータ辞書
  - モデル方針と評価指標
  - 運用要件とMLOps
  - シナリオ設計

- **`CLAUDE.md`** - リポジトリガイダンス
- **`README.md`** - 本ドキュメント

### 📊 データファイル
- **`Iphone_Sales_Data(1).csv`** - 実績データ
  - iPhone 12〜16の日次売上（2020年10月〜2025年6月）
  - 2,490レコード、5モデル

### 🔧 分析スクリプト

- **`iphone_forecast_refined.py`** - **v3.0 Refined（推奨）** ⭐
  - LightGBM + Optuna最適化
  - 外れ値検出・平滑化（±2σ閾値）
  - 24個の高度な特徴量エンジニアリング
  - 対数変換ラグ特徴量（ローンチフェーズ安定化）
  - 成長率メトリクス（加速度、前月比成長率）
  - インタラクション項（launch_x_stage等）
  - 3-fold時系列クロスバリデーション
  - CSV/PNG出力

### 📈 出力ファイル

**v3.0 Refined出力** (`iphone_forecast/output/`):
- **`forecast_iphone16_refined.csv`** - iPhone 16予測（v1.0/v2.0/v3.0比較）
- **`forecast_iphone17_refined.csv`** - iPhone 17予測（2025年9月発売、4ヶ月）
- **`forecast_refined_comparison.png`** - ビジュアル比較グラフ（3バージョン）

## 使用方法

### 📦 必要なライブラリ

```bash
pip install pandas numpy lightgbm scikit-learn matplotlib optuna
```

### ▶️ 実行方法

#### v3.0 Refined予測モデル（推奨）⭐
```bash
python3 iphone_forecast_refined.py
```
→ `iphone_forecast/output/` に以下が生成されます:
- `forecast_iphone16_refined.csv`
- `forecast_iphone17_refined.csv`
- `forecast_refined_comparison.png`

### 📊 出力の活用

1. **S&OP計画**: CSVファイルの予測値を使用（v3.0列を参照）
2. **モデル改善分析**: 比較グラフでv1.0/v2.0/v3.0の精度向上を確認
3. **新機種計画**: iPhone 17予測を使用（2025年9月発売想定）
4. **精度モニタリング**: MAPE/WAPE指標でモデルパフォーマンスを追跡

## モデルの詳細 v3.0

### 特徴量設計（24個）

#### コア特徴（18個、オリジナル）
- **時系列特徴**: 月、四半期、曜日、週番号、発売後経過日数/週数/月数
- **ライフサイクル特徴**: ライフサイクル段階、ホリデーシーズン、新学期、Q4フラグ
- **ラグ/移動平均**: Sales_MA7, Sales_MA30, Sales_Lag7, Sales_Lag30
- **ビジネス要因**: SimulatedPrice, PromoIntensity, IsNewModelLaunchMonth, ModelNumber

#### v3.0新規特徴（6個追加）
- **対数変換ラグ**: lag1_log, lag2_log, lag3_log（ローンチフェーズの変動を安定化）
- **成長率メトリクス**: mom_growth_ma3（前月比成長率平滑化）、acceleration（成長率の変化率）
- **インタラクション項**: launch_x_stage（ローンチ×ライフサイクルの相互作用）

### v3.0改善点

#### 外れ値検出・平滑化
- ±2σ閾値で4件の外れ値を検出・補正
- ローンチフェーズの異常なスパイクを平滑化

#### ハイパーパラメータ最適化（Optuna）
- 20試行で最適パラメータを探索
- `num_leaves`: 101, `learning_rate`: 0.0229
- `feature_fraction`: 0.765, `bagging_fraction`: 0.734
- L1/L2正則化: 0.208/0.313

#### バージョン別性能比較

| 指標 | v1.0 Baseline | v2.0 Improved | v3.0 Refined | 改善 |
|------|--------------|--------------|--------------|------|
| iPhone 16 MAPE | 23.41% | 22.53% | **13.34%** | ▲10.07pt ✓ |
| iPhone 16 WAPE | 23.76% | 22.94% | **13.56%** | ▲10.20pt ✓ |
| 主な改善 | 基本特徴量 | 18特徴量 | 外れ値+Optuna+対数ラグ | - |

### 重要特徴量トップ3（v3.0）
1. **ema3** (指数移動平均): 15,435 - 直近トレンドの重み付け平均
2. **ma3** (3ヶ月移動平均): 8,363 - 中期需要トレンド
3. **launch_month**: 4,399 - ローンチ月効果

## 今後の拡張（ロードマップ）

### フェーズ2: データ拡張
- [ ] 実際の価格・プロモーションデータ統合
- [ ] 在庫・欠品データ連携
- [ ] 国別・チャネル別セグメンテーション
- [ ] 競合データ（発売日、価格）

### フェーズ3: モデル高度化
- [ ] 階層型予測（Top-down/Bottom-up調整）
- [ ] Prophet/SARIMAとのアンサンブル
- [ ] Bayesian更新（予約データからのCold Start改善）
- [ ] 需要抑圧補正（欠品時の潜在需要推定）

### フェーズ4: 運用最適化
- [ ] 自動再学習パイプライン（週次/月次）
- [ ] ダッシュボード開発（国/チャネル/機種ピボット）
- [ ] APIエンドポイント
- [ ] アラート機能（誤差ドリフト検知）

### フェーズ5: 意思決定連携
- [ ] 在庫最適化（サービスレベル×予測分布）
- [ ] 価格最適化（弾力性×在庫×粗利）
- [ ] S&OPコンセンサス形成ワークフロー

## 技術スタック

- **言語**: Python 3.12+
- **データ処理**: pandas, numpy
- **機械学習**: LightGBM, scikit-learn
- **出力**: openpyxl (Excel)
- **将来**: Prophet, statsmodels, plotly (可視化)

## ライセンス・コンプライアンス

- 個人情報なし（集計レベルのみ）
- モデル説明責任（特徴量重要度の可視化）
- 外部データライセンス順守

## 参考資料

- **要件定義**: `requirements_document.md`
- **開発ガイダンス**: `CLAUDE.md`
- **ビジネスコンタクト**: Ops/需要計画チーム

---

**最終更新**: 2024年10月19日
**モデルバージョン**: v3.0 Refined（Optuna最適化版）
**データバージョン**: 2020-10 ~ 2025-06
**主な改善**: 外れ値検出・平滑化、Optunaハイパーパラメータ最適化、対数変換ラグ特徴量、MAPE 13.34%（目標達成）
